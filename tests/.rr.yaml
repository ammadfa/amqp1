# Example RoadRunner configuration for AMQP 1.0 driver

version: "3"

rr:
  grace_period: 30s
  print_pid: false
  pid_file: .rr.pid

server:
  command: "php worker.php"
  user: ""
  group: ""
  env:
    - SOME_KEY: "SOME_VALUE"
  relay: "pipes"
  relay_timeout: "20s"

# AMQP 1.0 global configuration
amqp1:
  addr: "amqp://guest:guest@127.0.0.1:5672/"
  container_id: "roadrunner-amqp1"
  
  # Optional TLS configuration
  # tls:
  #   cert: "/path/to/cert.pem"
  #   key: "/path/to/key.pem"
  #   root_ca: "/path/to/ca.pem"
  #   client_auth_type: "require_and_verify_client_cert"

# Jobs configuration
jobs:
  # Number of workers to allocate for job processing
  num_pollers: 10
  pipeline_size: 100000
  pool:
    num_workers: 10
    max_jobs: 0
    allocate_timeout: 60s
    destroy_timeout: 60s

  # List of pipelines to consume
  consume: ["emails", "files", "notifications"]

  # Pipeline configurations
  pipelines:
    # Basic email processing pipeline
    emails:
      driver: amqp1
      queue: "emails"
      exchange: "email-exchange"
      exchange_type: "direct"
      routing_key: "email.send"
      prefetch: 10
      priority: 10
      durable: true
      exchange_durable: true
      
    # File processing pipeline with advanced settings
    files:
      driver: amqp1
      queue: "file-processing"
      exchange: "files-exchange"
      exchange_type: "topic"
      routing_key: "files.#"
      prefetch: 5
      priority: 5
      durable: true
      exclusive: false
      multiple_ack: false
      requeue_on_fail: true
      delete_queue_on_stop: false
      
      # AMQP 1.0 specific settings
      link_name: "files-link"
      source_filter: "file-type = 'image'"
      
      # Exchange settings
      exchange_durable: true
      exchange_auto_delete: false
      
      # Queue settings
      queue_auto_delete: false
      queue_headers:
        x-max-length: 1000
        x-message-ttl: 3600000
      
      # Connection settings
      redial_timeout: 60
      
    # High-priority notifications pipeline
    notifications:
      driver: amqp1
      queue: "notifications"
      exchange: "notifications-exchange"
      exchange_type: "fanout"
      prefetch: 20
      priority: 15
      durable: true
      exchange_durable: true
      consumer_id: "notifications-consumer"

# HTTP configuration for management/monitoring
http:
  address: "0.0.0.0:8080"
  middleware: ["gzip"]
  
  pool:
    num_workers: 2
    allocate_timeout: 60s
    destroy_timeout: 60s

# Metrics and observability
metrics:
  address: "localhost:2112"

# Logging configuration
logs:
  mode: development
  level: error
  file_logger_options:
    log_output: "rr.log"
    max_size: 10
    max_age: 24
    max_backups: 10
    compress: false

# Status plugin for health checks
status:
  address: "localhost:2114"

# Optional: gRPC configuration
# grpc:
#   listen: "tcp://127.0.0.1:9001"
#   pool:
#     num_workers: 2
